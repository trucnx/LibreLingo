#!/usr/bin/env node
"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("fs")),r=require("path"),n=e(require("commander")),i=e(require("tiny-glob")),o=require("svelte/compiler"),a=require("estree-walker");
/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */
function c(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}function l(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,r=e[Symbol.asyncIterator];return r?r.call(e):(e=c(e),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(r){t[r]=e[r]&&function(t){return new Promise((function(n,i){(function(e,t,r,n){Promise.resolve(n).then((function(t){e({value:t,done:r})}),t)})(n,i,(t=e[r](t)).done,t.value)}))}}}function s(e,t,r){const n=t.replace(/\[(\w+)\]/gi,".$1").split(".");return n.reduce((e,t,i)=>{return t in e?e[t]:i<n.length-1?(o=n[i+1],Number.isNaN(parseInt(o))?e[t]={}:e[t]=[]):e[t]=r;var o},e)}function u(e){return e.properties.reduce((e,t)=>{if("Literal"===t.value.type&&t.value.value!==Object(t.value.value)){const r=t.key.name;e.meta[r]=t.value.value}return e},{node:e,meta:{}})}const f=new Set(["format","_","t"]),p=new Set(["number","date","time"]);function m(e){return e.instance?e.instance.content.body.filter(e=>"ImportDeclaration"===e.type&&"svelte-i18n"===e.source.value):[]}function d(e){return e.specifiers.find(e=>"imported"in e&&"defineMessages"===e.imported.name)}function y(e){const t=m(e);if(0===t.length)return[];const r=new Set(t.flatMap(e=>function(e){return e.specifiers.filter(e=>"imported"in e&&f.has(e.imported.name))}(e).map(e=>e.local.name)));if(0===r.size)return[];const n=[];function i(e){(function(e,t){if("CallExpression"!==e.type)return!1;let r;if("MemberExpression"!==e.callee.type||"Identifier"!==e.callee.property.type||p.has(e.callee.property.name)?"Identifier"===e.callee.type&&(r=e.callee):r=e.callee.object,!r||"Identifier"!==r.type)return!1;const n=r.name.slice(1);return t.has(n)})(e,r)&&(n.push(e),this.skip())}return a.walk(e.instance,{enter:i}),a.walk(e.html,{enter:i}),n}function w(e){const t=o.parse(e),r=y(t);return[...function(e){const t=[],r=m(e).find(d);if(null==r)return[];const n=d(r).local.name;return a.walk(e.instance,{enter(e){if(!1===function(e,t){return"CallExpression"===e.type&&(e.callee&&"Identifier"===e.callee.type&&e.callee.name===t)}(e,n))return;const[r]=e.arguments;"ObjectExpression"===r.type&&(t.push(r),this.skip())}}),t.flatMap(e=>e.properties.map(e=>e.value))}(t).map(e=>u(e)),...r.map(e=>{const[t,r]=e.arguments;if("ObjectExpression"===t.type)return u(t);const n=t,i=n.value;if(r&&"ObjectExpression"===r.type){const e=u(r);return e.meta.id=i,e}return{node:n,meta:{id:i}}})].filter(Boolean)}function h(e,{accumulator:t={},shallow:r=!1,overwrite:n=!1}={}){return w(e).forEach(e=>{let i=e.meta.default;if(void 0===i&&(i=""),r){if(!1===n&&e.meta.id in t)return;t[e.meta.id]=i}else{if(!1===n&&"undefined"!=(o=t,typeof e.meta.id.split(".").reduce((e,t)=>"object"!=typeof e?e:e[t],o)))return;s(t,e.meta.id,i)}var o}),t}const{readFile:v,writeFile:g,mkdir:b,access:j}=t.promises;n.command("extract <glob> [output]").description("extract all message definitions from files to a json").option("-s, --shallow","extract to a shallow dictionary (ids with dots interpreted as strings, not paths)",!1).option("--overwrite","overwrite the content of the output file instead of just appending new properties",!1).option("-c, --config <dir>",'path to the "svelte.config.js" file',process.cwd()).action(async(e,t,{shallow:n,overwrite:a,config:c})=>{var s,u;const f=(await i(e)).filter(e=>e.match(/\.html|svelte$/i)),p=await new Promise((function(e){e(function(e){if(e&&e.__esModule)return e;var t={};return e&&Object.keys(e).forEach((function(r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})})),t.default=e,t}(require(r.resolve(c,"svelte.config.js"))))})).catch(()=>null);let m={};null!=t&&!1===a&&await(e=>j(e).then(()=>!0).catch(()=>!1))(t)&&(m=await v(t).then(e=>JSON.parse(e.toString())).catch(e=>{console.warn(e),m={}}));try{for(var d,y=l(f);!(d=await y.next()).done;){const e=d.value;let t=(await v(e)).toString();if(p&&p.preprocess){t=(await o.preprocess(t,p.preprocess,{filename:e})).code}h(t,{accumulator:m,shallow:n})}}catch(e){s={error:e}}finally{try{d&&!d.done&&(u=y.return)&&await u.call(y)}finally{if(s)throw s.error}}const w=JSON.stringify(m,null,"  ");if(null==t)return console.log(w);await b(r.dirname(t),{recursive:!0}),await g(t,w)}),n.parse(process.argv);
